<style type="text/css">
	.list img { float: right;}
</style>
<h1>%project_name%</h1>
<hr />
<div id="listsDiv"></div>
<div id="modal">
	<form action="/" method="post">
		<div id="modal_dialog">
			<input type="hidden" name="list_index" />
			<input type="text" name="title" placeholder="Title" /><br />
			<textarea name="description" placeholder="Description"></textarea><br />
			<div class="buttons">
				<input type="submit" value="Save" /> 
				<input type="button" value="Cancel" onclick="onCancel()" />
			</div>
		</div>
	</form>
</div>

<script type="text/javascript">
var project = %project%;
var modal = document.getElementById("modal");
var form = document.querySelector("form");
var list_index = document.getElementsByName("list_index")[0];
var title = document.getElementsByName("title")[0];
var description = document.getElementsByName("description")[0];

window.onload = function() {

	var el;
	var text;
	var listsDiv = document.getElementById("listsDiv");

	project.lists.forEach(function(list_name, list_index) {
		var list = document.createElement("div");
		list.setAttribute("id", "list_"+list_index);
		list.setAttribute("ondrop", "drop(event)");
		list.setAttribute("ondragover", "allowDrop(event)");
		list.classList.add("list");

		el = document.createElement("img");
		el.setAttribute("src", "/plus.png");
		el.setAttribute("onclick", "createCard(" + list_index + ")");
		list.appendChild(el);

		el = document.createElement("h2");
		text = document.createTextNode(list_name);
		el.appendChild(text);
		list.appendChild(el);

		for (const card of project.cards) {
			if (card.list_index != list_index) continue;
			var c = makeCard(card);
			list.appendChild(c);
		}

		listsDiv.appendChild(list);	
	});
}

function makeCard(card) {
	var a = document.createElement("a");
	a.classList.add("card");
	a.setAttribute("id", "card_" + card.id);
	a.setAttribute("onclick", "zoomOnCard(findCard(" + card.id + "))");
	a.setAttribute("draggable", "true");
	a.setAttribute("ondragstart", "drag(event)");

	var el = document.createElement("div");
	var text = document.createTextNode(card.title);
	el.appendChild(text);

	a.appendChild(el);

	return a;
}

function findCard(id_of_card_to_find) {
	for (const card of project.cards) {
		if (card.id == id_of_card_to_find) return card;
	}
	return null;
}

function zoomOnCard(card) {
	form.action = "/" + card.id;
	list_index.value = card.list_index;
	title.value = card.title;
	description.value = card.description;

	modal.style.display = "block";
	title.focus();
}

function onCancel() {
	modal.style.display = "none";
	form.reset();
	zoomed_card = null;
}

function createCard(list_index) {

	var card = {
		"id" : 0,
		"list_index" : list_index,
		"position" : 0,
		"title" : "",
		"description" : "",
		"labels" : []
	};

	zoomOnCard(card);
}

function drag(ev) {
	ev.dataTransfer.setData("text", ev.target.id);
}

function allowDrop(ev) {
	ev.preventDefault();
}

function drop(ev) {
	ev.preventDefault();
	var id = ev.dataTransfer.getData("text");

	// Drop on the list, not the header, icon or other cards
	var list = ev.target;
	while (!list.classList.contains("list")) {
		list = list.parentNode;
	}

	// drop the card
	var cardDiv = document.getElementById(id);
	list.appendChild(cardDiv);

	// update the card in RAM
	var list_index = list.getAttribute("id").replace("list_", '');
	var card_id = cardDiv.id.replace("card_", "");
	var card = findCard(card_id);
	card.list_index = list_index;

	// update the card on the server
	var url = "/"+card_id+"/list_index";
	var data = "list_index="+list_index;
	ajax(url, data);
}

function ajax(url, data, callback) {
	var req = new XMLHttpRequest();
	req.addEventListener("load", function() {
		if (callback) callback(this);
	});
	req.open("POST", url);
	req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	req.send(data);
}

</script>
