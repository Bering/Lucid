<h1><input id="project_name" type="text" value="%project_name%" /></h1>
<hr />
<div id="listsDiv"></div>
<div id="modal">
	<form action="/" method="post">
		<div id="modal_dialog">
			<div>
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:red; border:solid 3px red;" onclick="toggleLabel(this, 'red')"></div>
				<input type="checkbox"style="display:none;" name="label1" value="1" />
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:orange; border:solid 3px orange;" onclick="toggleLabel(this, 'orange')"></div>
				<input type="checkbox"style="display:none;" name="label2" value="2" />
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:yellow; border:solid 3px yellow;" onclick="toggleLabel(this, 'yellow')"></div>
				<input type="checkbox"style="display:none;" name="label3" value="3" />
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:green; border:solid 3px green;" onclick="toggleLabel(this, 'green')"></div>
				<input type="checkbox"style="display:none;" name="label4" value="4" />
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:blue; border:solid 3px blue;" onclick="toggleLabel(this, 'blue')"></div>
				<input type="checkbox"style="display:none;" name="label5" value="5" />
				<div class="labelToggler" style="display:inline-block; width:69px; height:50px; background-color:magenta; border:solid 3px magenta;" onclick="toggleLabel(this, 'magenta')"></div>
				<input type="checkbox"style="display:none;" name="label6" value="6" />
			</div>
			<input type="hidden" name="list_index" />
		<input type="text" name="title" placeholder="Title" /><br />
			<textarea name="description" placeholder="Description"></textarea><br />
			<div class="buttons">
				<input type="submit" value="Save" /> 
				<input type="button" value="Cancel" onclick="onCancel()" />
			</div>
		</div>
	</form>
</div>

<script type="text/javascript">
var project = %project%;
var modal = document.getElementById("modal");
var form = document.querySelector("form");
var list_index = document.getElementsByName("list_index")[0];
var title = document.getElementsByName("title")[0];
var description = document.getElementsByName("description")[0];

window.onload = function() {

	var el;
	var text;
	var listsDiv = document.getElementById("listsDiv");

	document.addEventListener("keyup", function(event) {
		if (event.key === "Escape") onCancel();
	});

	document.getElementById("project_name").addEventListener("keyup", projectRename);

	project.lists.forEach(function(list_name, list_index) {
		var list = document.createElement("div");
		list.setAttribute("id", "list_"+list_index);
		list.setAttribute("ondrop", "drop(event)");
		list.setAttribute("ondragover", "allowDrop(event)");
		list.classList.add("list");

		el = document.createElement("img");
		el.setAttribute("src", "/add.png");
		el.setAttribute("onclick", "createCard(" + list_index + ")");
		list.appendChild(el);

		el = document.createElement("h2");
		text = document.createTextNode(list_name);
		el.appendChild(text);
		list.appendChild(el);

		var cardCount = 0;
		for (const card of project.cards) {
			if (card.list_index != list_index) continue;
			var c = makeCard(card);
			list.appendChild(c);
			cardCount++;
		}

		el = document.createElement("div");
		el.classList.add("card_count");
		if (cardCount == 1)
			text = document.createTextNode(cardCount + " card");
		else
			text = document.createTextNode(cardCount + " cards");
		el.appendChild(text);
		list.appendChild(el);

		listsDiv.appendChild(list);	
	});
}

function makeCard(card) {
	var a = document.createElement("a");
	a.classList.add("card");
	a.setAttribute("id", "card_" + card.id);
	a.setAttribute("onclick", "zoomOnCard(findCard(" + card.id + "))");
	a.setAttribute("draggable", "true");
	a.setAttribute("ondragstart", "drag(event)");

	var labels = doLabels(card);
	a.appendChild(labels);

	var div = document.createElement("div");
	div.classList.add("cardDiv");
	var text = document.createTextNode(card.title);
	div.appendChild(text);

	var pb = doProgressBar(card);
	if (pb) div.appendChild(pb);

	a.appendChild(div);
	return a;
}

function findCard(id_of_card_to_find) {
	for (const card of project.cards) {
		if (card.id == id_of_card_to_find) return card;
	}
	return null;
}

function doLabels(card) {
	var labels = document.createElement("div");
	labels.classList.add("labels");

	var labelCount = card.labels.length;
	for (var n = 0; n < labelCount; n++) {
		var label = document.createElement("div");
		label.classList.add("label"+card.labels[n]);
		label.style.width = 190/labelCount + "px";
		labels.appendChild(label);
	}

	return labels;
}

function doProgressBar(card) {
	var unchecked = card.description.match(/- \[ \] /g);
	if (unchecked == null)
		unchecked = 0;
	else
		unchecked = unchecked.length;
	
	var checked = card.description.match(/- \[x\] /g);
	if (checked == null)
		checked = 0
	else
		checked = checked.length;

	var total = 1.0 * (checked + unchecked);
	if (total == 0) return null;

	var percent = checked * 100 / total;

	var container = document.createElement("div");
	container.classList.add("progressArea");

		var progressBar = document.createElement("div");
		progressBar.classList.add("progressBar");
		if (percent) {
			var progress = document.createElement("div");
			progress.classList.add("progress");
			progress.style.width = percent+"%";
			progressBar.appendChild(progress);
		}

	container.appendChild(progressBar);

		var counts = document.createElement("div");
		counts.classList.add("checklist_counts");
			var text = document.createTextNode(checked + "/" + total);
			counts.appendChild(text);

	container.appendChild(counts);
	return container;
}

function zoomOnCard(card) {
	form.action = "/" + card.id;
	list_index.value = card.list_index;
	title.value = card.title;
	description.value = card.description;

	var labelDivs = document.querySelectorAll("div.labelToggler");
	for (var n = 0; n < labelDivs.length; n++) {
		var div = labelDivs[n];
		if (card.labels.includes(n+1)) {
			div.style.backgroundColor = div.style.borderColor;
			div.nextElementSibling.checked = true;
		}
		else {
			div.style.backgroundColor = "lightyellow";
			div.nextElementSibling.checked = false;
		}
	}

	modal.style.display = "block";
	title.focus();
}

function onCancel() {
	modal.style.display = "none";
	form.reset();
	zoomed_card = null;
}

function createCard(list_index) {

	var card = {
		"id" : 0,
		"list_index" : list_index,
		"position" : 0,
		"title" : "",
		"description" : "",
		"labels" : []
	};

	zoomOnCard(card);
}

function drag(ev) {
	ev.dataTransfer.setData("text", ev.target.id);
}

function allowDrop(ev) {
	ev.preventDefault();
}

function drop(ev) {
	ev.preventDefault();
	var id = ev.dataTransfer.getData("text");

	// find which card it was dropped on (if any)
	var insertBeforeCard = ev.target;
	while (!insertBeforeCard.classList.contains("card")) {
		if (insertBeforeCard.classList.contains("list")) {
			insertBeforeCard = null;
			break;
		}
		else
			insertBeforeCard = insertBeforeCard.parentNode;
	}

	// Find the list behind the header, icon or other cards
	var list = ev.target;
	while (!list.classList.contains("list")) {
		list = list.parentNode;
	}

	// if it wasn't dropped on a card, find the card it should be inserted before
	if (insertBeforeCard == null) {
		var cards = document.querySelectorAll("#"+list.getAttribute("id")+" .card");
		for(var n=0; n < cards.length; n++) {
			console.log(cards[n].offsetTop, ev.pageY);
			// +40 because of reasons (time to go to bed, let's figure it out tomorrow)
			if (cards[n].offsetTop + 40 > ev.pageY) {
				insertBeforeCard = cards[n];
				break;
			}
		}
	}

	// drop the card
	var cardDiv = document.getElementById(id);
	if(insertBeforeCard)
		list.insertBefore(cardDiv, insertBeforeCard);
	else
		list.appendChild(cardDiv);

	// Move the cards counter back to the bottom of the list
	var cardCount = document.querySelector("#"+list.getAttribute("id")+" div.card_count");
	list.removeChild(cardCount);
	list.appendChild(cardCount);

	// update the card's list_index in RAM
	var list_index = list.getAttribute("id").replace("list_", '');
	var card_id = cardDiv.id.replace("card_", "");
	var card = findCard(card_id);
	card.list_index = list_index;

	// update the cards position in RAM
	var cards = document.querySelectorAll("#list_"+list_index+" .card");
	var positions = [];
	for (var n=0; n < cards.length; n++) {
		var card_id = cards[n].getAttribute("id").replace("card_", "");
		positions.push(parseInt(card_id));
	}

	// update the cards on the server
	var url = "/drag_drop";
	var data = "list_index="+list_index;
	data += "&ids="+JSON.stringify(positions);
	ajax(url, data);
}

function ajax(url, data, callback) {
	var req = new XMLHttpRequest();
	req.addEventListener("load", function() {
		if (callback) callback(this);
	});
	req.open("POST", url);
	req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
	req.send(data);
}

function projectRename(event) {
	var name = document.querySelector("#project_name");

	if (event.key === "Escape")
		name.value = project.name;
	else if (event.key === "Enter") {
		ajax("/name", "name="+name.value);
	}
}

function toggleLabel(div, color) {
	if (div.style.backgroundColor == color) {
		div.style.backgroundColor = "lightyellow";
		div.nextElementSibling.checked = false;
	}
	else {
		div.style.backgroundColor = color;
		div.nextElementSibling.checked = true;
	}
}

</script>
